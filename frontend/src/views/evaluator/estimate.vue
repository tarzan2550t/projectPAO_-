<template>
  <router-link :to="`/evaluator/evaluatorindicator/${indicatorId}`">
    <button class="btn btn-outline mb-4">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö</button>
  </router-link>

  <div class="card bg-base-100 shadow-xl p-6 space-y-6">
    <h2 class="text-xl font-bold text-center">‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô (‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£)</h2>

    <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô -->
    <div class="grid grid-cols-2 gap-4">
      <div><b>‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô:</b> {{ data?.evaluatee_name }}</div>
      <div><b>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô:</b> {{ data?.name }}</div>
    </div>

    <!-- ‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ï‡∏ô‡πÄ‡∏≠‡∏á -->
    <div class="bg-base-200 p-4 rounded">
      <b>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ï‡∏ô‡πÄ‡∏≠‡∏á:</b>
      <p class="mt-1">{{ selfScoreText }}</p>
    </div>

    <!-- ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô -->
    <div>
      <b>‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</b>
      <div class="mt-2 space-y-1">
        <a
          v-if="data?.url_name"
          :href="data.url_name"
          target="_blank"
          class="link link-primary"
        >
          üîó ‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå
        </a>

        <div v-if="data?.file_name">
          <a :href="fileUrl" target="_blank" class="link link-success">
            üìÅ ‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö
          </a>
        </div>
      </div>
    </div>

    <!-- ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£ -->
    <div>
      <b>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£</b>
      <div class="mt-2 space-y-2">
        <label class="flex items-start gap-2">
          <input type="radio" :value="1" v-model="committeeScore" />
          <span>‡∏£‡∏∞‡∏î‡∏±‡∏ö 1 : ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á‡∏°‡∏≤‡∏Å</span>
        </label>

        <label class="flex items-start gap-2">
          <input type="radio" :value="2" v-model="committeeScore" />
          <span>‡∏£‡∏∞‡∏î‡∏±‡∏ö 2 : ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á</span>
        </label>

        <label class="flex items-start gap-2">
          <input type="radio" :value="3" v-model="committeeScore" />
          <span>‡∏£‡∏∞‡∏î‡∏±‡∏ö 3 : ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á</span>
        </label>

        <label class="flex items-start gap-2">
          <input type="radio" :value="4" v-model="committeeScore" />
          <span>‡∏£‡∏∞‡∏î‡∏±‡∏ö 4 : ‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á</span>
        </label>
      </div>
    </div>

    <!-- ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô -->
    <div>
      <b>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£</b>
      <textarea
        v-model="committeeComment"
        class="textarea textarea-bordered w-full mt-1"
        rows="3"
        placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô..."
      ></textarea>
    </div>

    <!-- ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô -->
    <div>
      <b>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£</b>
      <input
        type="file"
        class="file-input file-input-bordered w-full mt-1"
        accept="image/*"
        @change="onFileChange"
      />
      <div v-if="previewUrl" class="mt-2">
        <img :src="previewUrl" class="w-40 border rounded" />
      </div>
    </div>

    <button class="btn btn-success w-full" @click="submitScore">
      ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô
    </button>
  </div>
</template>

<script setup>
import { ref, onMounted, computed } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import api from '../api/axios'

const route = useRoute()
const router = useRouter()

const indicatorId = route.params.indicatorId
const evaluateeId = route.params.evaluateeId

const data = ref(null)
const committeeScore = ref(null)
const committeeComment = ref('')
const signatureFile = ref(null)
const previewUrl = ref(null)

const onFileChange = (e) => {
  const file = e.target.files[0]
  if (!file) return
  signatureFile.value = file
  previewUrl.value = URL.createObjectURL(file)
}

const fetchData = async () => {
  const res = await api.get(`/getattachment/${indicatorId}/${evaluateeId}`)
  data.value = res.data[0]

  if (data.value?.committee_comment) {
    committeeComment.value = data.value.committee_comment
  }
}

const selfScoreText = computed(() => {
  switch (Number(data.value?.self_assessment_score)) {
    case 1: return '‡∏£‡∏∞‡∏î‡∏±‡∏ö 1 : ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á‡∏°‡∏≤‡∏Å'
    case 2: return '‡∏£‡∏∞‡∏î‡∏±‡∏ö 2 : ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á'
    case 3: return '‡∏£‡∏∞‡∏î‡∏±‡∏ö 3 : ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á'
    case 4: return '‡∏£‡∏∞‡∏î‡∏±‡∏ö 4 : ‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á'
    default: return '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô'
  }
})

const fileUrl = computed(() => {
  if (!data.value?.storage_path) return ''
  const filename = data.value.storage_path.split('\\').pop()
  return `${api.defaults.baseURL.replace('/api','')}/uploads/misc/${filename}`
})

const submitScore = async () => {
  if (!committeeScore.value) {
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô')
    return
  }

  const formData = new FormData()
  formData.append('period_id', data.value.period_id)
  formData.append('indicator_id', indicatorId)
  formData.append('evaluatee_id', evaluateeId)
  formData.append('score', committeeScore.value)
  formData.append('comment', committeeComment.value || '')

  if (signatureFile.value) {
    formData.append('file', signatureFile.value)
  }

  await api.post('/createevaluationresults', formData)

  alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢')
  router.push('/evaluator/evaluatorperiod')
}

onMounted(fetchData)
</script>
