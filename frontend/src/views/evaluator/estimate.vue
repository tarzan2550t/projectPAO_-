<template>
  <div class="min-h-screen bg-gray-100 p-4 font-sans">
    <router-link :to="`/evaluator/evaluatorindicator/${indicatorId}`">
      <button class="btn btn-sm btn-outline mb-4">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö</button>
    </router-link>

    <div class="max-w-4xl mx-auto bg-white shadow-lg border border-gray-300 p-8 text-black">
      
      <div class="mb-6">
        <h2 class="text-xl font-bold text-center mb-6">‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 text-sm">
          <div class="flex items-end">
            <span class="font-bold whitespace-nowrap w-24">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</span>
            <div class="border-b border-dotted border-gray-400 w-full px-2 text-blue-700">
              {{ data?.evaluatee_name || '-' }}
            </div>
          </div>
          <div class="flex items-end">
            <span class="font-bold whitespace-nowrap w-24">‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß:</span>
            <div class="border-b border-dotted border-gray-400 w-full px-2">
              {{ data?.employee_id || '-' }} </div>
          </div>
          <div class="flex items-end">
            <span class="font-bold whitespace-nowrap w-24">‡πÅ‡∏ú‡∏ô‡∏Å/‡∏ù‡πà‡∏≤‡∏¢:</span>
            <div class="border-b border-dotted border-gray-400 w-full px-2">
              {{ data?.department || '-' }} </div>
          </div>
          <div class="flex items-end">
            <span class="font-bold whitespace-nowrap w-24">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô:</span>
            <div class="border-b border-dotted border-gray-400 w-full px-2">
              {{ new Date().toLocaleDateString('th-TH') }}
            </div>
          </div>
        </div>
      </div>

      <div class="overflow-x-auto border border-black mb-6">
        <table class="w-full text-sm text-left border-collapse">
          <thead class="bg-gray-100 text-center font-bold">
            <tr>
              <th rowspan="2" class="border border-black p-2 w-1/3">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤ / ‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î</th>
              <th colspan="4" class="border border-black p-2">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£)</th>
            </tr>
            <tr>
              <th class="border border-black p-1 w-24 bg-green-50">4<br><span class="text-xs font-normal">‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á</span></th>
              <th class="border border-black p-1 w-24">3<br><span class="text-xs font-normal">‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á</span></th>
              <th class="border border-black p-1 w-24">2<br><span class="text-xs font-normal">‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á</span></th>
              <th class="border border-black p-1 w-24 bg-red-50">1<br><span class="text-xs font-normal">‡∏ï‡πà‡∏≥‡∏°‡∏≤‡∏Å</span></th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="border border-black p-4 align-top">
                <div class="font-bold text-base mb-2">{{ data?.name }}</div>
                
                <div class="text-xs text-gray-600 space-y-2 mt-4 p-2 bg-gray-50 rounded border border-dashed border-gray-300">
                  <p><strong>‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ï‡∏ô‡πÄ‡∏≠‡∏á:</strong> <span class="text-blue-600">{{ selfScoreText }}</span></p>
                  
                  <div class="flex flex-wrap gap-2 mt-1">
                    <span class="font-bold">‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô:</span>
                    <a v-if="data?.url_name" :href="data.url_name" target="_blank" class="text-blue-500 hover:underline flex items-center gap-1">
                      üîó ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ô‡∏ö
                    </a>
                    <a v-if="data?.file_name" :href="fileUrl" target="_blank" class="text-green-600 hover:underline flex items-center gap-1">
                      üìÅ ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö
                    </a>
                    <span v-if="!data?.url_name && !data?.file_name" class="text-gray-400">- ‡πÑ‡∏°‡πà‡∏°‡∏µ -</span>
                  </div>
                </div>
              </td>

              <td class="border border-black text-center bg-green-50 align-middle hover:bg-green-100 cursor-pointer" @click="committeeScore = 4">
                <input type="radio" :value="4" v-model="committeeScore" class="radio radio-sm radio-success" />
              </td>
              <td class="border border-black text-center align-middle hover:bg-gray-100 cursor-pointer" @click="committeeScore = 3">
                <input type="radio" :value="3" v-model="committeeScore" class="radio radio-sm radio-primary" />
              </td>
              <td class="border border-black text-center align-middle hover:bg-gray-100 cursor-pointer" @click="committeeScore = 2">
                <input type="radio" :value="2" v-model="committeeScore" class="radio radio-sm radio-warning" />
              </td>
              <td class="border border-black text-center bg-red-50 align-middle hover:bg-red-100 cursor-pointer" @click="committeeScore = 1">
                <input type="radio" :value="1" v-model="committeeScore" class="radio radio-sm radio-error" />
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        
        <div class="border border-black p-4 relative pt-6">
          <span class="absolute top-0 left-2 -mt-3 bg-white px-2 font-bold text-sm">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</span>
          <textarea
            v-model="committeeComment"
            class="w-full h-32 p-2 outline-none resize-none text-sm bg-transparent"
            placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞..."
          ></textarea>
        </div>

        <div class="border border-black p-4 relative pt-6 flex flex-col items-center justify-between">
          <span class="absolute top-0 left-2 -mt-3 bg-white px-2 font-bold text-sm">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£</span>
          
          <div class="w-full flex justify-center py-2 min-h-[100px] items-center bg-gray-50 border border-dashed border-gray-300 cursor-pointer relative overflow-hidden group">
            <input
              type="file"
              class="absolute inset-0 opacity-0 cursor-pointer z-10"
              accept="image/*"
              @change="onFileChange"
            />
            
            <img v-if="previewUrl" :src="previewUrl" class="h-24 object-contain" />
            <div v-else class="text-center text-gray-400 text-xs group-hover:text-gray-600">
              <p>‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</p>
              <p>(‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û)</p>
            </div>
          </div>

          <div class="mt-2 text-center w-full">
            <div class="border-b border-black w-3/4 mx-auto mb-1"></div>
            <p class="text-xs">({{ committeeName || '‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô' }})</p>
          </div>
        </div>

      </div>

      <div class="mt-8 flex justify-end">
        <button class="btn btn-success px-8 text-white" @click="submitScore">
          <span class="mr-2">üíæ</span> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô
        </button>
      </div>

    </div>
  </div>
</template>

<script setup>
import { ref, onMounted, computed } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import api from '../api/axios'

const route = useRoute()
const router = useRouter()

const indicatorId = route.params.indicatorId
const evaluateeId = route.params.evaluateeId

const data = ref(null)
const committeeScore = ref(null)
const committeeComment = ref('')
const signatureFile = ref(null)
const previewUrl = ref(null)
const committeeName = ref('') // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö

const onFileChange = (e) => {
  const file = e.target.files[0]
  if (!file) return
  signatureFile.value = file
  previewUrl.value = URL.createObjectURL(file)
}

const fetchData = async () => {
  try {
    const res = await api.get(`/getattachment/${indicatorId}/${evaluateeId}`)
    data.value = res.data[0]

    if (data.value?.committee_comment) {
      committeeComment.value = data.value.committee_comment
    }
    // ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡πà‡∏≤‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏î‡πâ‡∏ß‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    if (data.value?.score) { 
        committeeScore.value = Number(data.value.score)
    }
  } catch (error) {
    console.error("Error fetching data", error)
  }
}

const selfScoreText = computed(() => {
  switch (Number(data.value?.self_assessment_score)) {
    case 1: return '‡∏£‡∏∞‡∏î‡∏±‡∏ö 1 (‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á‡∏°‡∏≤‡∏Å)'
    case 2: return '‡∏£‡∏∞‡∏î‡∏±‡∏ö 2 (‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á)'
    case 3: return '‡∏£‡∏∞‡∏î‡∏±‡∏ö 3 (‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á)'
    case 4: return '‡∏£‡∏∞‡∏î‡∏±‡∏ö 4 (‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á)'
    default: return '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô'
  }
})

const fileUrl = computed(() => {
  if (!data.value?.storage_path) return ''
  // ‡∏õ‡∏£‡∏±‡∏ö path ‡∏ï‡∏≤‡∏° environment ‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
  const filename = data.value.storage_path.split('\\').pop().split('/').pop()
  return `${api.defaults.baseURL.replace('/api','')}/uploads/misc/${filename}`
})

const submitScore = async () => {
  if (!committeeScore.value) {
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å')
    return
  }

  try {
    const formData = new FormData()
    formData.append('period_id', data.value.period_id)
    formData.append('indicator_id', indicatorId)
    formData.append('evaluatee_id', evaluateeId)
    formData.append('score', committeeScore.value)
    formData.append('comment', committeeComment.value || '')

    if (signatureFile.value) {
      formData.append('file', signatureFile.value)
    }

    await api.post('/createevaluationresults', formData)

    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢')
    router.push('/evaluator/evaluatorperiod')
  } catch (error) {
    console.error(error)
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å')
  }
}

onMounted(fetchData)
</script>

<style scoped>
/* ‡πÄ‡∏û‡∏¥‡πà‡∏° CSS ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏°‡∏ä‡∏±‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ */
table, th, td {
  border-color: #000; /* ‡∏™‡∏µ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡∏î‡∏≥‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô */
}
input[type="radio"] {
    cursor: pointer;
}
</style>